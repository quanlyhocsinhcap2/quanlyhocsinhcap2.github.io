<!DOCTYPE html>
<html lang="en">

<head>
    <title>Điểm Danh -THCS Việt Anh</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
</head>
<style>
    .Da_Chon {
        background-color: gray;
        color: black;
    }
    
    .color_ten {
        color: black !important;
    }
    
    .CHON {
        border: 1px solid blue;
        opacity: 0.5;
    }
    
    html {
        overflow-y: unset;
    }
</style>

<body>
    <!-- <div class="container-fluid">
      <div class="btn btn-outline-danger btn-block" id="Th_Thong_bao">
        KHUNG THÔNG BÁO
      </div>
    </div> -->
    <div class="container-fluid">
        <fieldset class="border m-2 p-2 text-info">
            <legend class="text-danger">Ứng dụng điểm danh học sinh được viết bởi Hoàng Văn Việt Anh - Nguyễn Hoàng Lĩnh</legend>

            <div class="fixed-top text-right mr-4 mt-2" id="Th_HS_nghi">
                <span class="text-white bg-danger btn border border-danger">
          Tổng học sinh nghỉ toàn trường :
          <u id="Th_Gio_hang">0</u>
        </span>
            </div>
            <div class="container-fluid">
                <a name="" id="" class="btn btn-primary" href="../../index.html" role="button"><i class="fa fa-home" aria-hidden="true"></i></a>
                <button id="Th_Khoi_6" class="btn btn-outline-primary">
          <i class="fa fa-graduation-cap" aria-hidden="true"></i> Khối 6
        </button>
                <button id="Th_Khoi_7" class="btn btn-outline-primary">
          <i class="fa fa-graduation-cap" aria-hidden="true"></i> Khối 7
        </button>
                <button id="Th_Khoi_8" class="btn btn-outline-primary">
          <i class="fa fa-graduation-cap" aria-hidden="true"></i> Khối 8
        </button>
                <button id="Th_Khoi_9" class="btn btn-outline-primary">
          <i class="fa fa-graduation-cap" aria-hidden="true"></i> Khối 9
        </button>
                <select class="btn btn-outline-danger" id="Th_Loc_Lop">

        </select>
                <button id="Th_sx_tang" class="btn btn-outline-primary">
          <i class="fa fa-sort-alpha-asc" aria-hidden="true"></i>
        </button>
                <button id="Th_sx_giam" class="btn btn-outline-primary">
          <i class="fa fa-sort-alpha-desc" aria-hidden="true"></i>
        </button> Nhập tên học sinh cần tìm:
                <input type="text" id="Th_gtTim" onkeyup="KeyCode(event)" />
                <button id="Th_Tim" class="btn btn-primary">
          <i class="fa fa-search-plus"></i>
        </button>
                <div class="float">

                </div>
            </div>
    </div>
    </fieldset>
    </div>
    <div class="container-fluid">
        <fieldset class="border m-2 p-2">
            <legend id="Th_Tieu_de"></legend>
            <div class="container-fluid" id="Th_ThongBao"></div>
            <div id="Th_Danh_sach"></div>
        </fieldset>
    </div>
    <!-- modal Button trigger modal -->
    <button type="button" class="btn btn-primary btn-lg d-none" id="Th_Show" data-toggle="modal" data-target="#modelId">
    Launch
  </button>

    <!-- Modal -->
    <div class="modal fade bd-example-modal-lg" id="modelId" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title text-danger" id="modelTitleId">Danh sách học sinh vắng</h4>
                    <button type="button" id="Th_Close" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>

                </div>
                <div class="modal-body" id="Th_Chi_tiet">
                    <div class="row" id="Th_Cha">
                        <div class="float-left">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Mã số</th>
                                        <th>Hình </th>
                                        <th>Họ tên </th>
                                        <th>Giới tính</th>
                                        <th>Lớp</th>
                                        <th>Lý do nghỉ</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="Th_Danh_sach_Dien_thoai_Mua">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="Th_dong">Đóng</button>
                    <button type="button" class="btn btn-primary" id="Th_Dong_y">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- end modal -->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="../Xu_ly/Xu_ly_3L.js"></script>
    <script>
        var Danh_sach_Hoc_sinh = Doc_Danh_sach_Hoc_sinh().Danh_sach_Hoc_sinh;
        var Nhat_ky_Diem_danh = Doc_Nhat_ky_Diem_danh();
        var dateNow = new Date().toLocaleDateString().split("/")
        var dateChuan = dateNow[1] + "-" + dateNow[0] + "-" + dateNow[2]
        var dateTheoNhatKy = dateNow[1] + "_" + dateNow[0] + "_" + dateNow[2]
        var dateShow = dateNow[1] + "/" + dateNow[0] + "/" + dateNow[2]

        var duLieuDiemDanh;
        var flag = 0;
        var duLieu = {
            "Ngay": `${dateTheoNhatKy}`,
            "Lop": []
        }
        Nhat_ky_Diem_danh.forEach(x => {
            if (x.Ngay == dateTheoNhatKy) {
                duLieuDiemDanh = x;
                flag++;
            }
        })
        if (flag == 0) {
            duLieuDiemDanh = duLieu;
            Ghi_Nhat_ky_Diem_danh(duLieu);
        }


        function kiemTraDiemDanh(lop) {
            var flag = 0;
            Nhat_ky_Diem_danh.forEach(x => {
                if (x.Ngay == dateTheoNhatKy) {
                    duLieuDiemDanh = x;
                    //console.log(x)
                    x.Lop.forEach(y => {
                        if (y == lop) {
                            flag++;
                        }
                    })

                }
            })
            if (flag == 0) {
                return false;
            } else {
                return true;
            }

        }

        //var checkLop = kiemTraDiemDanh("6.3")
        //console.log("===>" + Nhat_ky_Diem_danh)

        var Tong_Hs_Vang = 0;
        if (sessionStorage.getItem("Danh_sach_Chon") != undefined) {
            var ds = JSON.parse(sessionStorage.getItem("Danh_sach_Chon"))
            Tong_Hs_Vang = ds.length
        }
        var hs_vang = [];
        Danh_sach_Hoc_sinh.forEach(x => {
            if (x.Danh_sach_Vang.length != 0) {

                x.Danh_sach_Vang.forEach(y => {
                    if (y != null) {
                        if (y.Ngay == getNewDate()) {
                            hs_vang.push(x.Ma_so)
                        }

                    }

                })
            }

        })
        let kq_Hs_Vang = deduplicate(hs_vang)
        if (kq_Hs_Vang.length != 0) {
            sessionStorage.setItem("Danh_sach_Da_Chon", JSON.stringify(kq_Hs_Vang))
        }
        Tong_Hs_Vang += kq_Hs_Vang.length

        Th_Gio_hang.innerHTML = `<u><span style="font-weight: bold;"> ${Tong_Hs_Vang} </span> học sinh</u>`

        var Danh_sach_HS_Theo_lop;

        Th_Khoi_6.onclick = () => {
            Danh_sach_HS_Theo_lop = Danh_sach_Hoc_sinh.filter(
                x => x.Lop.Khoi.Ma_so == "KHOI_6"
            );
            Tao_Bo_loc(Danh_sach_HS_Theo_lop)
        };


        Th_Khoi_7.onclick = () => {
            Danh_sach_HS_Theo_lop = Danh_sach_Hoc_sinh.filter(
                x => x.Lop.Khoi.Ma_so == "KHOI_7"
            );
            Tao_Bo_loc(Danh_sach_HS_Theo_lop)
        };
        Th_Khoi_8.onclick = () => {
            Danh_sach_HS_Theo_lop = Danh_sach_Hoc_sinh.filter(
                x => x.Lop.Khoi.Ma_so == "KHOI_8"
            );
            Tao_Bo_loc(Danh_sach_HS_Theo_lop)
        };
        Th_Khoi_9.onclick = () => {
            Danh_sach_HS_Theo_lop = Danh_sach_Hoc_sinh.filter(
                x => x.Lop.Khoi.Ma_so == "KHOI_9"
            );
            Tao_Bo_loc(Danh_sach_HS_Theo_lop)
        };

        function Tao_Bo_loc(Danh_sach_HS) {
            Them_loc_Lop(Danh_sach_HS);
            Xuat_Danh_sach_Hoc_sinh(Danh_sach_HS, Th_Danh_sach);
            try {
                Th_Loc_Lop.onchange();
            } catch (error) {

            }

        }
        Th_Khoi_6.click();

        //xóa trùng trong mảng
        function deduplicate(arr) {
            return arr.filter((value, index, arr) => arr.indexOf(value) === index);
        }
        ////////////////////////////////////

        //add bộ lọc theo lớp
        function Them_loc_Lop(Danh_sach_Khoi) {
            var Ds_Lop = [];
            Danh_sach_Khoi.forEach(x => {
                Ds_Lop.push(x.Lop.Ma_so)
            });

            let ans = deduplicate(Ds_Lop);

            var text = "";
            for (var i = 0; i < ans.length; i++) {
                var number = ans[i].split(".");
                var Ten_lop = ans[i].split("_");
                var ktDiemDanh = kiemTraDiemDanh(Ten_lop[1])
                console.log("Kq==>" + ktDiemDanh)
                if (parseInt(number[1]) == 1) {
                    if (ktDiemDanh == true) {
                        text += `<option selected="selected" value="${ans[i]}">Lớp ${Ten_lop[1]} - Đã điểm danh</option>`
                    } else {
                        text += `<option selected="selected" value="${ans[i]}">Lớp ${Ten_lop[1]}</option>`
                    }

                } else {
                    if (ktDiemDanh == true) {
                        text += `<option value="${ans[i]}">Lớp ${Ten_lop[1]} - Đã điểm danh</option>`
                    } else {
                        text += `<option value="${ans[i]}">Lớp ${Ten_lop[1]}</option>`
                    }

                }
            }
            Th_Loc_Lop.innerHTML = text;
        }
        ///////////////////////////////////////////

        var DS_HS_Theo_Lop;

        Th_Loc_Lop.onchange = () => {
            var flag = 0;
            var lop = Th_Loc_Lop.value;
            var layLop = lop.split("_");
            DS_HS_Theo_Lop = Danh_sach_HS_Theo_lop.filter(x => x.Lop.Ma_so == lop)
            console.log("Lớp: " + layLop[1])
            Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
            duLieuDiemDanh.Lop.forEach(x => {
                if (x == layLop[1]) {
                    flag++;
                }
            })
            if (flag == 0) {
                duLieuDiemDanh.Lop.push(layLop[1])
                Ghi_Nhat_ky_Diem_danh(duLieuDiemDanh)
            }
            console.log(duLieuDiemDanh)
            Th_Tieu_de.innerHTML = `DANH SÁCH HỌC SINH <span class="text-danger"> ${DS_HS_Theo_Lop[0].Lop.Ten.toUpperCase()} </span> - TỔNG SỐ HỌC SINH : <span class="text-danger"> ${DS_HS_Theo_Lop.length} </span> - ĐIỂM DANH NGÀY <span class="text-danger"> ${dateShow} </span>`
        }

        Th_Loc_Lop.onchange();

        Th_HS_nghi.onclick = () => {
            if (sessionStorage.getItem("Danh_sach_Chon") != undefined || sessionStorage.getItem("Danh_sach_Da_Chon") != undefined) {
                Th_Show.click();
            }
        }

        function KeyCode(event) {
            if (event.keyCode == 13) {
                var gtTim = event.target.value
                console.log(gtTim)
                var Danh_sach_Tim = DS_HS_Theo_Lop.filter(x => x.Ho_ten.toLowerCase().includes(gtTim.toLowerCase()))
                Xuat_Danh_sach_Hoc_sinh(Danh_sach_Tim, Th_Danh_sach)
            }
        }

        Th_sx_tang.onclick = () => {
            Sap_Tang_theo_Ten();
        }
        Th_sx_giam.onclick = () => {
            Sap_Giam_theo_Ten();
        }

        function Sap_Tang_theo_Ten() {
            // Là chuỗi
            DS_HS_Theo_Lop.sort((a, b) => a.Ho_ten.localeCompare(b.Ho_ten))
            Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
        }

        function Sap_Giam_theo_Ten() {
            // Là chuỗi
            DS_HS_Theo_Lop.sort((a, b) => b.Ho_ten.localeCompare(a.Ho_ten))
            Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
        }
        var Danh_sach_Cap_nhat;
        Th_Show.onclick = () => {


            Danh_sach_Cap_nhat = []
            Danh_sach_Chon_Cap_Nhat = []
            Danh_sach_Chon = JSON.parse(sessionStorage.getItem("Danh_sach_Chon"))
            Danh_sach_Da_Chon = JSON.parse(sessionStorage.getItem("Danh_sach_Da_Chon"))

            if (sessionStorage.getItem("Danh_sach_Chon") != undefined) {
                Danh_sach_Chon.forEach(Hs => {
                    var Hoc_sinh = Danh_sach_Hoc_sinh.find(x => x.Ma_so == Hs)
                    Danh_sach_Cap_nhat.push(Hoc_sinh)
                    Danh_sach_Chon_Cap_Nhat.push(Hoc_sinh)
                })
            }
            if (sessionStorage.getItem("Danh_sach_Da_Chon") != undefined) {
                Danh_sach_Da_Chon.forEach(Hs => {
                    var Hoc_sinh = Danh_sach_Hoc_sinh.find(x => x.Ma_so == Hs)
                    Danh_sach_Cap_nhat.push(Hoc_sinh)
                })
            }



            //console.log(Danh_sach_Cap_nhat)
            Xuat_Danh_sach_Hs_Nghi(Danh_sach_Cap_nhat, Th_Danh_sach_Dien_thoai_Mua)


        }

        function Xuat_Danh_sach_Hs_Nghi(Danh_sach_Hs_Nghi, Th_Cha) {
            Th_Cha.innerHTML = ""
            var noi_dung_HTML = ``
            var noi_dung_HTML2 = ``
            Danh_sach_Hs_Nghi.forEach(Hoc_sinh_Nghi => {
                noi_dung_HTML += `
                <tr id="${Hoc_sinh_Nghi.Ma_so}-boChon">
                    <td>${Hoc_sinh_Nghi.Ma_so}</td>
                    <td scope="row">
                        <img src=${Dia_chi_Media}/HS_1.png style="width:30px" />
                    </td >
                    <td>${Hoc_sinh_Nghi.Ho_ten}</td>
                    <td>${Hoc_sinh_Nghi.Gioi_tinh}</td>
                    <td>${Hoc_sinh_Nghi.Lop.Ten}</td>
                `
                var flag = 0;
                console.log(kq_Hs_Vang)
                kq_Hs_Vang.forEach(y => {
                    console.log("==>" + y)
                    if (Hoc_sinh_Nghi.Ma_so == y) {
                        noi_dung_HTML += `
                              <td>${Hoc_sinh_Nghi.Danh_sach_Vang[Hoc_sinh_Nghi.Danh_sach_Vang.length - 1].Ly_do}</td>
                                <td>Đã lưu</td>`
                        flag++
                        console.log(noi_dung_HTML2)
                    }
                })
                if (flag == 0) {
                    noi_dung_HTML += `
                            <td>
                        <select
              class="btn btn-sm btn-outline-danger" id="${Hoc_sinh_Nghi.Ma_so}">
              <option value="Bệnh">Bệnh</option>
              <option value="Trốn học">Trốn học </option>
              <option value="Nhà có việc">Nhà có việc </option>
              <option value="1">Khác </option>
            </select>
                    </td>
                            <td><button type="button" class="btn btn-primary" onClick="boChonHS('${Hoc_sinh_Nghi.Ma_so}-boChon');">Bỏ chọn</button></td>`
                }


            })
            console.log(kq_Hs_Vang)
            Th_Cha.innerHTML = noi_dung_HTML

        }
        // Th_delete.onclick=()=>{
        //   var Ma_Hs =  Th_delete.value
        //   sessionStorage.getItem("Danh_sach_Chon")
        // }

        function kiem_tra_Da_Chon() {
            var x = document.getElementsByClassName("CHON Da_Chon card m-1");
            console.log(x);
        }
        Th_Tim.onclick = () => {
            var gtTim = Th_gtTim.value
            console.log(gtTim)
            var Danh_sach_Tim = DS_HS_Theo_Lop.filter(x => x.Ho_ten.toLowerCase().includes(gtTim.toLowerCase()))
            Xuat_Danh_sach_Hoc_sinh(Danh_sach_Tim, Th_Danh_sach)
        }
        Th_gtTim.onchange = () => {
            if (Th_gtTim.value == "") {
                Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
            }
        }

        kiem_tra_Da_Chon();
        Th_Dong_y.onclick = () => {
            var Ds_Dat = []
            Danh_sach_Chon_Cap_Nhat.forEach(Hoc_sinh => {
                var HS_Vang = {
                    "Ngay": getNewDate(),
                    "Ly_do": `${document.getElementById(Hoc_sinh.Ma_so).value}`
                }
                var Hoc_sinh_Vang = {
                    "Hoc_sinh": Hoc_sinh,
                    "HS_Vang": HS_Vang
                }
                var Hoc_sinh = Danh_sach_Hoc_sinh.find(x => x.Ma_so == Hoc_sinh.Ma_so)
                Hoc_sinh.Danh_sach_Vang.push(HS_Vang)
                console.log(Hoc_sinh.Danh_sach_Vang)
                Ds_Dat.push(Hoc_sinh_Vang)
                kq_Hs_Vang.push(`${Hoc_sinh.Ma_so}`)
            })
            if (Danh_sach_Chon_Cap_Nhat.length == 0) {
                Th_ThongBao.innerHTML = `<div class="alert alert-warning alert-dismissible fade show">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <strong>Cảnh báo!</strong> Hiện không có sinh viên nào được chọn mới
  </div>`

            } else {
                console.log("Hoc sinh chon cap nhat" + Danh_sach_Chon_Cap_Nhat.length)
                var Kq = Ghi_Danh_sach_Vang(Ds_Dat)
                console.log(Danh_sach_Cap_nhat)
                    //console.log("--->" + Kq)
                var cap_nhat_ds = []
                Danh_sach_Cap_nhat.forEach(Hoc_sinh => {
                        // let shadesEl = document.querySelector('.CHON');
                        // shadesEl.classList.remove('CHON');
                        cap_nhat_ds.push(Hoc_sinh.Ma_so)
                    })
                    //console.log(Kq)
                console.log("So hs" + cap_nhat_ds.length)
                sessionStorage.setItem("Danh_sach_Da_Chon", JSON.stringify(cap_nhat_ds))
                sessionStorage.removeItem("Danh_sach_Chon")
                    //Th_Gio_hang.innerHTML = 0;
            }
            Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
                //Xuat_Danh_sach_Hs_Nghi(Danh_sach_Cap_nhat, Th_Danh_sach_Dien_thoai_Mua)
            Th_dong.click()
        }


        function boChonHS(id) {
            var element = document.getElementById(id).remove();
            var getIdHS = id.split("-");
            console.log(getIdHS[0])

            var ds = []
            if (sessionStorage.getItem("Danh_sach_Chon") != undefined) {
                ds = JSON.parse(sessionStorage.getItem("Danh_sach_Chon"))
            }
            var vt = ds.indexOf(getIdHS[0])
            if (vt == -1) {
                ds.push(getIdHS[0]) // Thêm
            } else {
                ds.splice(vt, 1) // Xóa
            }

            if (ds.length > 0) {
                sessionStorage.setItem("Danh_sach_Chon", JSON.stringify(ds))
            } else {
                sessionStorage.removeItem("Danh_sach_Chon")
            }

            Xuat_Danh_sach_Hoc_sinh(DS_HS_Theo_Lop, Th_Danh_sach)
            Th_Gio_hang.innerHTML = `<u><span style="font-weight: bold;"> ${ds.length + kq_Hs_Vang.length} </span> học sinh</u>`
        }

        function getNewDate() {
            var d = new Date();
            var thang = checkTime(d.getMonth() + 1);
            console.log(thang)
            var ngay = checkTime(d.getDate());
            var nam = d.getFullYear();
            return `${nam}-${thang}-${ngay}`
        }

        function checkTime(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
    </script>
</body>

</html>